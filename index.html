<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cổng Dịch Vụ Nhân Sự - LaPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print { .no-print { display: none !important; } body { background: white; } input, select, textarea { border: none !important; border-bottom: 1px dotted #ccc !important; padding-left: 0; background: transparent; } }
        .tab-btn.active { transform: translateY(-2px); }
        #btn-tab-attendance.active { background-color: #1e40af; color: white; border-color: #172554; }
        #btn-tab-ot.active { background-color: #c2410c; color: white; border-color: #7c2d12; }
        #btn-tab-leave.active { background-color: #15803d; color: white; border-color: #14532d; }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 pb-10">
    <div class="max-w-6xl mx-auto px-4 pt-6">
        <div class="flex items-center justify-between bg-white rounded-xl shadow-sm p-6 mb-6 border border-slate-200">
            <div class="flex items-center space-x-4">
                <div class="h-12 w-12 bg-blue-800 text-white rounded-lg flex items-center justify-center text-2xl"><i class="fas fa-university"></i></div>
                <div><h1 class="text-xl font-bold uppercase">Cổng Dịch Vụ Nhân Sự</h1></div>
            </div>
            <div class="text-sm font-semibold text-slate-600 hidden md:block" id="currentDate"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6 no-print">
            <button onclick="switchTab('tab-attendance')" id="btn-tab-attendance" class="tab-btn active bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex items-center gap-3"><i class="fas fa-clipboard-check text-xl"></i><div class="text-left font-bold text-sm uppercase">Xác Nhận Công</div></button>
            <button onclick="switchTab('tab-ot')" id="btn-tab-ot" class="tab-btn bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex items-center gap-3"><i class="fas fa-clock text-xl"></i><div class="text-left font-bold text-sm uppercase">Làm Thêm Giờ</div></button>
            <button onclick="switchTab('tab-leave')" id="btn-tab-leave" class="tab-btn bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex items-center gap-3"><i class="fas fa-plane-departure text-xl"></i><div class="text-left font-bold text-sm uppercase">Xin Nghỉ Phép</div></button>
        </div>

        <div class="bg-white shadow-xl rounded-xl border border-slate-200 overflow-hidden relative min-h-[600px]">
            <div id="loading" class="hidden loading-overlay absolute inset-0 z-50 flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div><p class="font-bold text-blue-800">Đang gửi dữ liệu...</p></div>

            <div id="tab-attendance" class="tab-content p-6 md:p-10">
                <h2 class="text-2xl font-bold text-blue-800 uppercase border-b-2 border-blue-800 pb-4 mb-6">Đơn Xác Nhận Ngày Công</h2>
                <form onsubmit="handleSubmit(event, 'xac_nhan_cong')">
                    <div class="bg-slate-50 p-6 rounded mb-8 grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div><label class="text-xs font-bold uppercase text-slate-500">Họ và tên *</label><input type="text" id="att_name" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Mã NV (ID) *</label><input type="text" id="att_id" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Chức danh</label><input type="text" id="att_title" class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Bộ phận *</label><input type="text" id="att_dept" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Cơ sở</label><select id="att_base" class="w-full border rounded px-3 py-2 bg-white outline-none"><option value="DinhLe">Đinh Lê</option><option value="CauGiay">Cầu Giấy</option></select></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Email của bạn *</label><input type="email" id="att_email" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div class="md:col-span-3"><label class="text-xs font-bold uppercase text-red-500">Email Quản lý (Duyệt) *</label><input type="email" id="att_manager_email" required class="w-full border border-red-200 bg-red-50 rounded px-3 py-2 outline-none"></div>
                    </div>
                    <div class="flex justify-between mb-2"><h3 class="font-bold">Chi tiết ngày công</h3><button type="button" onclick="addRow('attendance-table-body')" class="no-print bg-blue-600 text-white text-xs px-3 py-2 rounded font-bold">Thêm dòng</button></div>
                    <div class="overflow-x-auto border rounded mb-6"><table class="min-w-full divide-y divide-slate-200 text-sm"><thead class="bg-slate-100"><tr><th class="px-3 py-2 text-left">Ngày</th><th class="px-2 py-2">Giờ vào</th><th class="px-2 py-2">Giờ ra</th><th class="px-2 py-2 bg-blue-50 text-blue-700">CC Vào</th><th class="px-2 py-2 bg-blue-50 text-blue-700">CC Ra</th><th class="px-2 py-2 w-16 text-center">Công</th><th class="px-2 py-2 w-20">Loại</th><th class="px-2 py-2">Lý do</th><th class="px-2 py-2 no-print w-10">Xóa</th></tr></thead><tbody id="attendance-table-body" class="bg-white divide-y"></tbody></table></div>
                    <div class="text-right no-print"><button type="submit" class="bg-blue-800 text-white font-bold py-3 px-8 rounded hover:bg-blue-900">GỬI XÁC NHẬN</button></div>
                </form>
            </div>

            <div id="tab-ot" class="tab-content hidden p-6 md:p-10">
                <h2 class="text-2xl font-bold text-orange-600 uppercase border-b-2 border-orange-500 pb-4 mb-6">Đăng Ký Làm Thêm</h2>
                <form onsubmit="handleSubmit(event, 'lam_them')">
                    <div class="bg-orange-50 p-6 rounded mb-6 grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div><label class="text-xs font-bold uppercase text-slate-500">Họ và tên *</label><input type="text" id="ot_name" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Email của bạn *</label><input type="email" id="ot_email" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Bộ phận *</label><input type="text" id="ot_dept" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-red-500">Email Quản lý *</label><input type="email" id="ot_manager_email" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                    </div>
                    <div class="flex justify-between mb-2"><h3 class="font-bold text-orange-800">Chi tiết ca làm</h3><button type="button" onclick="addOTRow()" class="no-print bg-orange-600 text-white text-xs px-3 py-2 rounded font-bold">Thêm ca</button></div>
                    <div id="ot-list-container" class="space-y-3 mb-6"></div>
                    <div class="bg-orange-100 p-4 rounded flex justify-between font-bold text-orange-900 mb-6"><span>TỔNG GIỜ OT:</span><span><span id="ot-total-hours">0</span> giờ</span></div>
                    <div class="mb-6"><label class="text-sm font-bold block mb-2">Ghi chú</label><textarea id="ot_note" class="w-full border rounded p-3 h-20 outline-none"></textarea></div>
                    <div class="text-right no-print"><button type="submit" class="bg-orange-600 text-white font-bold py-3 px-8 rounded hover:bg-orange-700">ĐĂNG KÝ OT</button></div>
                </form>
            </div>

            <div id="tab-leave" class="tab-content hidden p-6 md:p-10">
                <h2 class="text-2xl font-bold text-green-700 uppercase border-b-2 border-green-600 pb-4 mb-6">Đơn Xin Nghỉ Phép</h2>
                <form onsubmit="handleSubmit(event, 'nghi_phep')">
                    <div class="bg-green-50 p-6 rounded mb-6 grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div><label class="text-xs font-bold uppercase text-slate-500">Họ và tên *</label><input type="text" id="leave_name" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Email của bạn *</label><input type="email" id="leave_email" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Chức vụ *</label><input type="text" id="leave_title" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div><label class="text-xs font-bold uppercase text-slate-500">Bộ phận *</label><input type="text" id="leave_dept" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold uppercase text-red-500">Email Quản lý *</label><input type="email" id="leave_manager_email" required class="w-full border rounded px-3 py-2 bg-white outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                         <label class="cursor-pointer border p-3 rounded text-center hover:bg-gray-50"><input type="radio" name="leaveType" value="Phép năm" required> Phép năm</label>
                         <label class="cursor-pointer border p-3 rounded text-center hover:bg-gray-50"><input type="radio" name="leaveType" value="Nghỉ ốm"> Nghỉ ốm</label>
                         <label class="cursor-pointer border p-3 rounded text-center hover:bg-gray-50"><input type="radio" name="leaveType" value="Việc riêng"> Việc riêng</label>
                         <label class="cursor-pointer border p-3 rounded text-center hover:bg-gray-50"><input type="radio" name="leaveType" value="Không lương"> Không lương</label>
                    </div>
                    <div class="bg-white p-5 border rounded grid grid-cols-1 md:grid-cols-3 gap-6 items-end mb-6">
                        <div><label class="text-sm font-bold">Từ ngày</label><input type="date" id="leaveStartDate" onchange="calcLeave()" required class="w-full border rounded px-3 py-2"></div>
                        <div><label class="text-sm font-bold">Đến ngày</label><input type="date" id="leaveEndDate" onchange="calcLeave()" required class="w-full border rounded px-3 py-2"></div>
                        <div class="bg-green-50 p-2 rounded text-center font-bold text-green-700"><label class="text-xs uppercase">Tổng</label><div><input type="number" id="leaveTotalDays" value="0" readonly class="w-12 bg-transparent text-center"> ngày</div></div>
                    </div>
                    <div class="mb-6"><label class="text-sm font-bold block mb-2">Lý do nghỉ</label><textarea id="leave_reason" required class="w-full border rounded p-3 h-24 outline-none"></textarea></div>
                    <div class="text-right no-print"><button type="submit" class="bg-green-600 text-white font-bold py-3 px-8 rounded hover:bg-green-700">GỬI ĐƠN</button></div>
                </form>
            </div>
        </div>
    </div>
    <div id="successModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-50"><div class="bg-white p-8 rounded-2xl text-center"><i class="fas fa-check text-green-600 text-3xl mb-4"></i><h3 class="text-xl font-bold mb-2">Thành công!</h3><p class="mb-6">Đã gửi dữ liệu cho quản lý.</p><button onclick="document.getElementById('successModal').classList.add('hidden')" class="bg-blue-800 text-white py-2 px-6 rounded font-bold">Đóng</button></div></div>

    <script>
        const N8N_WEBHOOK_URL = 'https://apchn-host.lapage.vn/webhook/submit-portal'; // <--- THAY LINK CỦA BẠN
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN');
        document.addEventListener('DOMContentLoaded', () => { addRow('attendance-table-body'); addOTRow(); });
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.remove('hidden'); document.getElementById('btn-'+id).classList.add('active'); }
        
        function addRow(id) { document.getElementById(id).insertAdjacentHTML('beforeend', `<tr><td class="p-2"><input type="date" class="item-date w-full border-b text-sm"></td><td class="p-2"><input type="time" class="item-in w-full border-b text-sm"></td><td class="p-2"><input type="time" class="item-out w-full border-b text-sm"></td><td class="p-2 bg-blue-50"><input type="time" class="item-cc-in w-full border-b text-sm text-blue-800 bg-transparent"></td><td class="p-2 bg-blue-50"><input type="time" class="item-cc-out w-full border-b text-sm text-blue-800 bg-transparent"></td><td class="p-2"><input type="text" class="item-total w-full border-b text-sm text-center" placeholder="8"></td><td class="p-2"><input type="text" class="item-type w-full border-b text-sm" placeholder="HC"></td><td class="p-2"><input type="text" class="item-reason w-full border-b text-sm"></td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></td></tr>`); }
        
        function addOTRow() { document.getElementById('ot-list-container').insertAdjacentHTML('beforeend', `<div class="ot-item bg-white border rounded p-3 mb-2 relative"><button type="button" onclick="removeOT(this)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button><div class="grid grid-cols-12 gap-2 mb-2"><div class="col-span-5 bg-slate-50 p-2"><div class="flex gap-1"><input type="time" onchange="calcOT(this)" class="ot-start-time w-1/2 border text-sm"><input type="date" onchange="calcOT(this)" value="${new Date().toISOString().split('T')[0]}" class="ot-start-date w-1/2 border text-sm"></div></div><div class="col-span-5 bg-slate-50 p-2"><div class="flex gap-1"><input type="time" onchange="calcOT(this)" class="ot-end-time w-1/2 border text-sm"><input type="date" onchange="calcOT(this)" value="${new Date().toISOString().split('T')[0]}" class="ot-end-date w-1/2 border text-sm"></div></div><div class="col-span-2 text-center pt-2 font-bold text-orange-600 row-hours">0</div></div><input type="text" class="ot-project w-full border-b text-sm" placeholder="Mô tả công việc..."></div>`); }
        function removeOT(btn) { if(document.querySelectorAll('.ot-item').length>1) btn.closest('.ot-item').remove(); updateTotalOT(); }
        function calcOT(inp) { const row=inp.closest('.ot-item'); const s=new Date(row.querySelector('.ot-start-date').value+'T'+row.querySelector('.ot-start-time').value); const e=new Date(row.querySelector('.ot-end-date').value+'T'+row.querySelector('.ot-end-time').value); row.querySelector('.row-hours').innerText = ((e-s)/36e5 > 0 ? (e-s)/36e5 : 0).toFixed(1); updateTotalOT(); }
        function updateTotalOT() { let t=0; document.querySelectorAll('.row-hours').forEach(e=>t+=parseFloat(e.innerText)||0); document.getElementById('ot-total-hours').innerText=t.toFixed(1); }
        function calcLeave() { const s=new Date(document.getElementById('leaveStartDate').value); const e=new Date(document.getElementById('leaveEndDate').value); document.getElementById('leaveTotalDays').value = ((e-s)/864e5 >= 0 ? (e-s)/864e5 + 1 : 0); }

        function handleSubmit(e, type) {
            e.preventDefault(); document.getElementById('loading').classList.remove('hidden');
            let d = { form_type: type, submitted_at: new Date().toISOString() };
            if(type==='xac_nhan_cong') {
                d.ho_ten=val('att_name'); d.id_cc=val('att_id'); d.chuc_danh=val('att_title'); d.bo_phan=val('att_dept'); d.co_so=val('att_base'); d.email_nv=val('att_email'); d.email_quan_ly=val('att_manager_email');
                d.chi_tiet=[]; document.querySelectorAll('#attendance-table-body tr').forEach(r=>{ let dt=r.querySelector('.item-date').value; if(dt) d.chi_tiet.push({ngay:dt, gio_vao:r.querySelector('.item-in').value, gio_ra:r.querySelector('.item-out').value, cc_vao:r.querySelector('.item-cc-in').value, cc_ra:r.querySelector('.item-cc-out').value, tong:r.querySelector('.item-total').value, hinh_thuc:r.querySelector('.item-type').value, ly_do:r.querySelector('.item-reason').value}); });
            } else if(type==='lam_them') {
                d.ho_ten=val('ot_name'); d.email_nv=val('ot_email'); d.bo_phan=val('ot_dept'); d.email_quan_ly=val('ot_manager_email'); d.tong_gio=document.getElementById('ot-total-hours').innerText; d.ghi_chu=val('ot_note');
                d.chi_tiet=[]; document.querySelectorAll('.ot-item').forEach(r=>{ let sd=r.querySelector('.ot-start-date').value; if(sd) d.chi_tiet.push({bat_dau:sd+' '+r.querySelector('.ot-start-time').value, ket_thuc:r.querySelector('.ot-end-date').value+' '+r.querySelector('.ot-end-time').value, so_gio:r.querySelector('.row-hours').innerText, cong_viec:r.querySelector('.ot-project').value}); });
            } else {
                d.ho_ten=val('leave_name'); d.email_nv=val('leave_email'); d.chuc_vu=val('leave_title'); d.bo_phan=val('leave_dept'); d.email_quan_ly=val('leave_manager_email'); d.loai_nghi=document.querySelector('input[name="leaveType"]:checked')?.value; d.tu_ngay=val('leaveStartDate'); d.den_ngay=val('leaveEndDate'); d.tong_ngay=val('leaveTotalDays'); d.ly_do=val('leave_reason');
            }
            fetch(N8N_WEBHOOK_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}).then(r=>{document.getElementById('loading').classList.add('hidden'); if(r.ok){document.getElementById('successModal').classList.remove('hidden'); e.target.reset();} else alert('Lỗi: '+r.status);}).catch(e=>{document.getElementById('loading').classList.add('hidden'); alert('Lỗi kết nối N8N');});
        }
        function val(id) { return document.getElementById(id).value; }
    </script>
</body>
</html>
