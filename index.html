<!DOCTYPE html>
<html lang="vi">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THÔNG TIN NHÂN SỰ - APCHN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd; /* Màu chủ đạo */
            --bg-color: #f0f2f5;
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Roboto', sans-serif; 
            color: #333;
            padding-bottom: 40px;
        }

        .main-container {
            max-width: 960px; /* Tối ưu cho iPad ngang và Laptop */
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        /* Header Logo Section */
        .header-banner {
            background: white;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid var(--primary-color);
        }

        .logo-img {
            max-width: 250px; /* Kích thước logo trên máy tính */
            height: auto;
            margin-bottom: 15px;
        }

        .form-title {
            color: #1a3a5c;
            font-weight: 700;
            font-size: 1.5rem;
            text-transform: uppercase;
            margin-bottom: 0;
        }

        /* Form Styling */
        .form-padding {
            padding: 30px;
        }

        .section-header {
            background-color: #e7f1ff;
            color: #0d6efd;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 700;
            margin-top: 25px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-left: 5px solid #0d6efd;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 5px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
            border-color: #86b7fe;
        }

        /* Nút Gửi */
        .btn-submit-wrapper {
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .btn-submit {
            background: linear-gradient(45deg, #0d6efd, #0043a8);
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
            transition: transform 0.2s;
        }

        .btn-submit:active {
            transform: scale(0.98);
        }

        /* Mobile Optimization */
        @media (max-width: 576px) {
            .main-container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .form-padding {
                padding: 20px 15px;
            }
            .logo-img {
                max-width: 180px; /* Logo nhỏ hơn trên điện thoại */
            }
            .form-title {
                font-size: 1.2rem;
            }
            .section-header {
                font-size: 1rem;
            }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header-banner">
            <img src="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp" alt="Logo Viet My" class="logo-img">
            <h1 class="form-title">HỒ SƠ NHÂN SỰ / HR PROFILE</h1>
            <p class="text-muted mt-2 mb-0">Hệ thống quản lý nhân sự tập trung APCHN</p>
        </div>

        <div class="form-padding">
            <form id="hrForm" autocomplete="off">
                
                <div class="section-header">1. Thông tin cá nhân / Personal Info</div>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Họ và tên / Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="ho_ten" placeholder="Nhập chữ in hoa..." required style="text-transform: uppercase;">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Giới tính / Gender <span class="text-danger">*</span></label>
                        <select class="form-select" name="gioi_tinh" required>
                            <option value="">--Chọn--</option>
                            <option value="Nam">Nam / Male</option>
                            <option value="Nữ">Nữ / Female</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Quốc tịch</label>
                        <input type="text" class="form-control" name="quoc_tich" value="Việt Nam">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Ngày sinh / DOB <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="ngay_sinh" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nơi sinh / Place of Birth</label>
                        <input type="text" class="form-control" name="noi_sinh">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Số điện thoại / Phone <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" name="so_dien_thoai" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Email cá nhân <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Tình trạng hôn nhân</label>
                        <select class="form-select" name="hon_nhan">
                            <option value="Độc thân">Độc thân / Single</option>
                            <option value="Đã kết hôn">Đã kết hôn / Married</option>
                            <option value="Ly hôn">Ly hôn / Divorced</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Địa chỉ thường trú / Permanent Address</label>
                        <input type="text" class="form-control" name="dia_chi_thuong_tru">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Nơi ở hiện tại / Current Address</label>
                        <input type="text" class="form-control" name="noi_o_hien_tai">
                    </div>
                </div>

                <div class="section-header">2. Giấy tờ tùy thân / ID Card</div>
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Số CCCD / ID Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="so_cccd" required>
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Ngày Cấp</label>
                        <input type="date" class="form-control" name="ngay_cap_cccd">
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Nơi cấp</label>
                        <input type="text" class="form-control" name="noi_cap_cccd">
                    </div>
                </div>

                <div class="section-header">3. Trình độ học vấn / Education</div>
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Trình độ cao nhất</label>
                        <select class="form-select" name="trinh_do">
                            <option value="Đại học">Đại học</option>
                            <option value="Cao đẳng">Cao đẳng</option>
                            <option value="Thạc Sỹ">Thạc Sỹ</option>
                            <option value="Tiến Sỹ">Tiến Sỹ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Chuyên ngành</label>
                        <input type="text" class="form-control" name="chuyen_nganh">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Trường đào tạo</label>
                        <input type="text" class="form-control" name="truong_dao_tao">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Bằng cấp khác (nếu có)</label>
                        <input type="text" class="form-control" name="bang_cap_khac">
                    </div>
                </div>

                <div class="section-header">4. Tài chính & Pháp lý / Finance & Legal</div>
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Tên chủ tài khoản</label>
                        <input type="text" class="form-control" name="ten_tk_ngan_hang" style="text-transform: uppercase;">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Số tài khoản</label>
                        <input type="text" class="form-control" name="so_tk_ngan_hang">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Ngân hàng - Chi nhánh</label>
                        <input type="text" class="form-control" name="chi_nhanh_ngan_hang" placeholder="VD: VCB - CN Ba Đình">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Mã số thuế cá nhân</label>
                        <input type="text" class="form-control" name="mst_ca_nhan">
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Nơi cấp MST</label>
                        <input type="text" class="form-control" name="noi_cap_mst">
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Ngày cấp MST</label>
                        <input type="date" class="form-control" name="ngay_cap_mst">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Số sổ BHXH (Nếu có)</label>
                        <input type="text" class="form-control" name="so_bhxh" placeholder="Giảng viên thỉnh giảng bỏ qua">
                    </div>
                </div>

                <div class="section-header">5. Gia đình / Family</div>
                <div class="mb-3">
                    <label class="form-label text-primary fw-bold">Thông tin con (Họ tên - Ngày sinh)</label>
                    <div class="row g-2">
                        <div class="col-12"><input type="text" class="form-control" name="con_1" placeholder="Con 1..."></div>
                        <div class="col-12"><input type="text" class="form-control" name="con_2" placeholder="Con 2..."></div>
                        <div class="col-12"><input type="text" class="form-control" name="con_3" placeholder="Con 3..."></div>
                    </div>
                </div>
                
                <div class="mb-3">
                     <label class="form-label text-primary fw-bold">Người phụ thuộc (Giảm trừ gia cảnh)</label>
                     <div class="card p-2 bg-light mb-2">
                        <div class="row g-2">
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="npt_1_ten" placeholder="Họ tên NPT 1"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_1_mst" placeholder="MST NPT 1"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_1_qh" placeholder="Mối quan hệ"></div>
                        </div>
                     </div>
                     <div class="card p-2 bg-light">
                        <div class="row g-2">
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="npt_2_ten" placeholder="Họ tên NPT 2"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_2_mst" placeholder="MST NPT 2"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_2_qh" placeholder="Mối quan hệ"></div>
                        </div>
                     </div>
                </div>

                <div class="col-12">
                    <label class="form-label text-danger fw-bold">Liên hệ khẩn cấp / Emergency Contact <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="lien_he_khan_cap" placeholder="Tên - SĐT - Mối quan hệ" required>
                </div>

                <div class="section-header">6. Công việc & Hồ sơ / Job & Docs</div>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Loại hợp đồng / Contract Type</label>
                        <select class="form-select" name="loai_hop_dong" id="contractType" onchange="checkContractType()">
                            <option value="Hợp đồng thỉnh giảng">Hợp đồng thỉnh giảng</option>
                            <option value="Hợp đồng chính thức">Hợp đồng chính thức</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <input type="text" class="form-control mt-2 d-none" name="loai_hop_dong_khac" id="otherContract" placeholder="Nhập loại hợp đồng...">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Phòng ban / Department</label>
                        <select class="form-select" name="phong_ban">
                            <option value="Phòng NSVH">Phòng NSVH</option>
                            <option value="Phòng MKT">Phòng MKT</option>
                            <option value="Phòng Kinh doanh">Phòng Kinh doanh</option>
                            <option value="Phòng Đào tạo">Phòng Đào tạo</option>
                            <option value="Ban Lãnh Đạo">Ban Lãnh Đạo</option>
                            <option value="Phòng Tuyển sinh">Phòng Tuyển sinh</option>
                            <option value="Phòng Kế toán">Phòng Kế toán</option>
                            <option value="Thư ký khoa">Thư ký khoa</option>
                            <option value="Khoa CH">Khoa CH</option>
                            <option value="Khoa BCH">Khoa BCH</option>
                        </select>
                    </div>
                    
                    <div class="col-12 mt-4">
                        <div class="p-3 border border-primary border-2 border-dashed rounded text-center bg-white">
                            <label class="form-label fw-bold mb-2">Ảnh hồ sơ cá nhân / Photos (Tối đa 5 ảnh) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="fileInput" multiple accept="image/*" required>
                            <small class="text-muted d-block mt-2">Chấp nhận: JPG, PNG, WEBP. Hệ thống tự tạo thư mục lưu trữ.</small>
                        </div>
                    </div>
                </div>

                <div class="btn-submit-wrapper">
                    <button type="button" class="btn btn-primary btn-submit" id="btnSubmit" onclick="submitForm()">GỬI HỒ SƠ / SUBMIT</button>
                </div>

            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="mt-3 text-primary" id="loadingText">Đang xử lý dữ liệu...</h5>
        <p class="text-muted small">Vui lòng không tắt trình duyệt.</p>
    </div>

    <script>
        function checkContractType() {
            const select = document.getElementById('contractType');
            const otherInput = document.getElementById('otherContract');
            if (select.value === 'Khác') {
                otherInput.classList.remove('d-none');
                otherInput.required = true;
            } else {
                otherInput.classList.add('d-none');
                otherInput.required = false;
            }
        }

        function submitForm() {
            const form = document.getElementById('hrForm');
            // Kiểm tra validate HTML5 (Required fields)
            if (!form.checkValidity()) {
                form.reportValidity(); // Hiển thị lỗi đỏ
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            // Hiện loading
            loadingOverlay.classList.remove('d-none');
            loadingText.innerText = "Đang lưu thông tin cá nhân...";

            // Gọi hàm Google Script để lưu text
            google.script.run.withSuccessHandler(function(response) {
                if (response.status === 'SUCCESS') {
                    loadingText.innerText = "Đang tải ảnh lên (Step 2/2)...";
                    // Sau khi có ID folder, tiến hành upload ảnh
                    uploadPhotos(response.folderId);
                } else {
                    alert('Lỗi hệ thống: ' + response.message);
                    loadingOverlay.classList.add('d-none');
                }
            }).processForm(form);
        }

        function uploadPhotos(folderId) {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            let uploadedCount = 0;
            const totalFiles = files.length;

            if (totalFiles === 0) {
                finishSubmission();
                return;
            }

            // Loop qua từng file để convert và gửi
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result; // Base64
                    
                    // Cập nhật text loading
                    document.getElementById('loadingText').innerText = `Đang tải ảnh ${index + 1}/${totalFiles}...`;

                    google.script.run.withSuccessHandler(function() {
                        uploadedCount++;
                        if (uploadedCount === totalFiles) {
                            finishSubmission();
                        }
                    }).uploadFilesToFolder(data, folderId, file.name);
                };
                reader.readAsDataURL(file);
            });
        }

        function finishSubmission() {
            document.getElementById('loadingOverlay').classList.add('d-none');
            alert("✅ XONG! Cảm ơn bạn đã gửi hồ sơ thành công.");
            document.getElementById('hrForm').reset();
            window.scrollTo(0, 0); // Cuộn lên đầu
        }
    </script>
</body>
</html>
